<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Boa Parte</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/dashboard.css">
<style>
        /* Scrollbar para WebKit */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
    
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
    
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
            border: 2px solid #f1f1f1;
        }
    
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    
        body {
            margin: 0;
            height: 100vh;
            overflow-y: auto;
        }
    
        html {
            height: 100%;
        }
    
        .dashboard-container {
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .contacts-list {
            overflow-y: visible;
            padding: 10px;
        }
    </style>
    
    <script>
        // Create global messages object and welcome message function
        window.welcomeMessage = function(name) {
            const hour = new Date().getHours();
            let greeting;
            
            if (hour >= 5 && hour < 12) {
                greeting = "Bom dia";
            } else if (hour >= 12 && hour < 18) {
                greeting = "Boa tarde";
            } else {
                greeting = "Boa noite";
            }

            return `${greeting}, ${name}! Graça e Paz do Senhor Jesus!\n\n` +
                   `Seja muito bem-vindo(a) à Igreja Batista Solidária! A Juventude da Igreja Batista Solidária (JIBS) também celebra a sua chegada e se alegra em recebê-lo(a). É uma honra tê-lo(a) conosco e agradecemos por compartilhar seu contato.\n\n` +
                   `Que este momento seja especial em sua vida e que você se sinta acolhido(a) e abençoado(a) por Deus. Estamos aqui para caminhar ao seu lado e auxiliar no que for preciso.\n\n` +
                   `Que o Senhor renove sua paz, sua alegria e sua esperança hoje e sempre!\n\n` +
                   `Com carinho,\n` +
                   `Juventude da Igreja Batista Solidária (JIBS) e Igreja Batista Solidária`;
        };
    </script>
    <script src="utils/messages.js"></script>
    <script src="js/auth.js"></script>
    <link rel="icon" type="image/png" href="images/image.png">
</head>
<body class="dashboard">
    <!-- Elementos Decorativos -->
    <div class="decorative-circle circle-1"></div>
    <div class="decorative-circle circle-2"></div>
    <div class="decorative-circle circle-3"></div>
    <div class="decorative-circle circle-4"></div>
    <div class="decorative-circle circle-5"></div>
    <div class="decorative-circle circle-6"></div>
    
    <div class="logo-container">
        <img src="images/image2.png" alt="Logo" class="logo">
    </div>

    <!-- Container Principal -->
    <div class="dashboard-container">
        <!-- Cabeçalho -->
        <header class="dashboard-header">
            <h2>Dashboard - Boa Parte</h2>
            <div class="user-info">
                <div id="username-display" class="user-badge">Anderson</div>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </header>

        <!-- Botões de Navegação -->
        <div class="button-container">
            <button class="dashboard-btn" onclick="window.location.href='members.html'">
                <i class="fas fa-users"></i> Lista de Membros
            </button>
            <button class="dashboard-btn" onclick="window.location.href='excel.html'">
                <i class="fas fa-table"></i> Tabela Excel
            </button>
            <button class="dashboard-btn admin-only" onclick="window.location.href='admin-panel.html'">
                <i class="fas fa-chart-line"></i> Painel Administrativo
            </button>
            <button class="dashboard-btn admin-only" onclick="window.location.href='admin.html'">
                <i class="fas fa-cogs"></i> Admin
            </button>
            <button class="dashboard-btn admin-only" onclick="window.location.href='users.html'">
                <i class="fas fa-user-cog"></i> Gerenciar Usuários
            </button>
            <button class="dashboard-btn anderson-only" onclick="window.location.href='whatsapp-config.html'">
                <i class="fab fa-whatsapp"></i> Configurar WhatsApp
            </button>
        </div>

        <!-- Área de Visitantes -->
        <div class="visitor-container">
            <h2>Adicionar Visitante</h2>
            <p class="visitor-subtitle">Clique em adicionar contato e adicione os contatos dos visitantes (Obs: Data de aniversário é opcional)</p>
            <button class="add-contact-button" onclick="showAddContactForm()">
                <i class="fas fa-user-plus"></i> Adicionar Contato
            </button>
        </div>

        <!-- Filtro de Mês -->
        <div class="filter-section">
            <h3 class="filter-title"><i class="fas fa-calendar-alt"></i> Filtrar por Mês</h3>
            <div class="filter-container">
                <select id="month-select" class="filter-select">
                    <option value="0">Todos os meses</option>
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Março</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
                <button class="ok-button" onclick="handleMonthFilter()">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
            </div>
        </div>

        <!-- Resultado do Mês -->
        <div id="month-result" class="month-result">
            <h3>Contatos do mês: <span id="selected-month">Abril</span></h3>
        </div>

        <!-- Lista de Contatos -->
        <div id="contacts-list" class="contacts-list"></div>
    </div>

    <!-- Modais -->
    <div id="add-contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adicionar Novo Contato</h2>
                <span class="close" onclick="hideAddContactForm()">&times;</span>
            </div>
            <form id="contact-form" onsubmit="createContact(event)">
                <div class="form-group">
                    <label for="name">Nome</label>
                    <input type="text" id="name" name="name" required placeholder="Digite o nome">
                </div>
                <div class="form-group">
                    <label for="phone">Telefone</label>
                    <input type="tel" id="phone" name="phone" required placeholder="(00) 00000-0000" onkeyup="formatPhoneNumber(this)" maxlength="15">
                </div>
                <div class="form-group">
                    <label for="birthday">Data de Nascimento</label>
                    <input type="date" id="birthday" name="birthday" placeholder="Opcional">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="submit-btn">Adicionar Contato</button>
                    <button type="button" class="cancel-btn" onclick="hideAddContactForm()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-member-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Membro</h2>
                <span class="close" onclick="closeModal('edit-member-modal')">&times;</span>
            </div>
            <form id="edit-member-form" onsubmit="updateMember(event)">
                <input type="hidden" id="edit-member-id">
                <div class="form-group">
                    <label for="edit-name">
                        <i class="fas fa-user"></i> Nome
                    </label>
                    <input type="text" id="edit-name" name="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-phone">
                        <i class="fas fa-phone"></i> Telefone
                    </label>
                    <input type="tel" id="edit-phone" name="edit-phone" required>
                </div>
                <div class="form-group">
                    <label for="edit-birthday">
                        <i class="fas fa-birthday-cake"></i> Data de Nascimento
                    </label>
                    <input type="date" id="edit-birthday" name="edit-birthday" placeholder="Opcional">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeModal('edit-member-modal')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification" style="display: none;">
        <span id="notification-message"></span>
    </div>

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script>
    // Configurações Globais
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 
        'Maio', 'Junho', 'Julho', 'Agosto',
        'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    // Funções de Utilidade
    function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length === 0) {
            input.value = '(';
            return;
        }
        
        if (value.length <= 2) {
            input.value = `(${value}`;
            return;
        }
        
        if (value.length <= 7) {
            input.value = `(${value.slice(0,2)}) ${value.slice(2)}`;
            return;
        }
        
        if (value.length <= 11) {
            input.value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
            return;
        }
        
        input.value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7,11)}`;
    }

    function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${isError ? 'error' : 'success'}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Funções de Modal
    function showAddContactForm() {
        const modal = document.getElementById('add-contact-modal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Reset form and set today as max date for birthday
        const form = document.getElementById('contact-form');
        form.reset();
        const birthdayInput = document.getElementById('birthday');
        birthdayInput.max = new Date().toISOString().split('T')[0];
    }

    function hideAddContactForm() {
        const modal = document.getElementById('add-contact-modal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Permite rolagem
        document.getElementById('contact-form').reset();
    }

    // Funções de Contatos
    async function loadContacts() {
        try {
            // Usa a rota correta da API
            const response = await fetch('/api/contacts/all', {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Erro ao carregar contatos');
            }

            const data = await response.json();
            
            if (!data.success) {
                throw new Error('Erro ao carregar dados dos contatos');
            }

            displayContacts(data.contacts);

        } catch (error) {
            console.error('Erro ao carregar contatos:', error);
            showNotification('❌ ' + error.message, true);
        }
    }

    async function createContact(event) {
        event.preventDefault();
        
        try {
            const formData = {
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.replace(/\D/g, ''),
                birthday: document.getElementById('birthday').value || null,
                owner: localStorage.getItem('username'),
                username: localStorage.getItem('username'),
                receivedMessage: false
            };

            // Validações
            if (formData.name.length < 3) {
                throw new Error('Nome deve ter pelo menos 3 caracteres');
            }

            if (formData.phone.length < 10) {
                throw new Error('Telefone inválido');
            }

            const response = await fetch('/api/contacts', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                throw new Error('Erro ao criar contato');
            }

            const data = await response.json();
            
            if (data.success) {
                showNotification('✅ Contato adicionado com sucesso!');
                hideAddContactForm();
                await loadContacts();
            } else {
                throw new Error(data.message || 'Erro ao criar contato');
            }
        } catch (error) {
            console.error('Erro:', error);
            showNotification('❌ ' + error.message, true);
        }
    }

    async function editContact(contactId) {
        try {
            const response = await fetch(`/api/contacts/${contactId}`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Erro ao carregar dados do contato');

            const contact = await response.json();
            
            // Preenche o formulário de edição
            document.getElementById('edit-member-id').value = contactId;
            document.getElementById('edit-name').value = contact.name;
            document.getElementById('edit-phone').value = contact.phone;
            if (contact.birthday) {
                document.getElementById('edit-birthday').value = new Date(contact.birthday).toISOString().split('T')[0];
            }

            // Mostra o modal e desabilita scroll
            document.getElementById('edit-member-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        } catch (error) {
            showNotification('❌ ' + error.message, true);
        }
    }

    async function deleteContact(contactId) {
        try {
            const response = await fetch(`/api/contacts/${contactId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Erro ao excluir contato');
            }

            const data = await response.json();
            
            if (data.success) {
                showNotification('✅ Contato excluído com sucesso!');
                await loadContacts();
            } else {
                throw new Error(data.message || 'Erro ao excluir contato');
            }
        } catch (error) {
            console.error('Erro:', error);
            showNotification('❌ ' + error.message, true);
        }
    }

    async function updateMember(event) {
        event.preventDefault();
        
        const contactId = document.getElementById('edit-member-id').value;
        const formData = {
            name: document.getElementById('edit-name').value,
            phone: document.getElementById('edit-phone').value.replace(/\D/g, ''),
            birthday: document.getElementById('edit-birthday').value || null
        };

        try {
            const response = await fetch(`/api/contacts/${contactId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            });

            if (!response.ok) throw new Error('Erro ao atualizar contato');

            showNotification('✅ Contato atualizado com sucesso!');
            closeModal('edit-member-modal');
            await loadContacts();
        } catch (error) {
            showNotification('❌ ' + error.message, true);
        }
    }

    // Funções de Interface
    function createContactElement(contact) {
        const contactElement = document.createElement('div');
        contactElement.className = 'contact-card';
        
        const messageStatus = contact.receivedMessage ? 'sent' : 'pending';
        const statusClass = contact.receivedMessage ? 'status-sent' : 'status-pending';
        const statusText = contact.receivedMessage ? 'Mensagem Enviada' : 'Mensagem Pendente';

        contactElement.innerHTML = `
            <div class="contact-info">
                <h3>${contact.name}</h3>
                <p><i class="fas fa-phone"></i> ${contact.phone}</p>
                ${contact.birthday ? 
                    `<p><i class="fas fa-birthday-cake"></i> ${new Date(contact.birthday).toLocaleDateString('pt-BR')}</p>` : ''}
                <div class="contact-metadata">
                    <span><i class="fas fa-user"></i> ${contact.owner || contact.username || 'N/A'}</span>
                    <span><i class="fas fa-calendar"></i> ${new Date(contact.createdAt).toLocaleDateString('pt-BR')}</span>
                    <span class="message-status ${statusClass}">
                        <i class="fas ${contact.receivedMessage ? 'fa-check-circle' : 'fa-clock'}"></i>
                        ${statusText}
                    </span>
                </div>
            </div>
            <div class="button-container">
                <button onclick="toggleActionMenu(this)" class="main-action-button">
                    <i class="fas fa-ellipsis-v"></i> Ações
                </button>
                <div class="action-menu">
                    <button onclick="sendWhatsAppMessage('${contact.phone}', '${contact.name}', '${contact._id}')" class="action-button send-button">
                        <i class="fab fa-whatsapp"></i> Enviar Mensagem
                    </button>
                    <button onclick="editContact('${contact._id}')" class="action-button edit-button">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="makeMember('${contact._id}')" class="action-button make-member-btn">
                        <i class="fas fa-user-plus"></i> Tornar Membro
                    </button>
                    <button onclick="deleteContact('${contact._id}')" class="action-button delete-button">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                    <button onclick="markAsNotSent('${contact._id}')" class="action-button not-messaged-button">
                        <i class="fas fa-times-circle"></i> Marcar como Não Enviada
                    </button>
                    <button onclick="sendServiceReminder('${contact.phone}', '${contact.name}', '${contact._id}')" class="action-button reminder-btn">
                        <i class="fas fa-church"></i> Enviar Msg Lembrete
                    </button>
                </div>
            </div>
        `;

        return contactElement;
    }

    // Funções de Ações
    async function sendWhatsAppMessage(phone, name, contactId) {
        try {
            const response = await fetch('/api/send-whatsapp', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ phone, name, contactId })
            });

            const data = await response.json();
            
            if (!response.ok) throw new Error(data.message);

            showNotification('✅ Mensagem enviada com sucesso!');
            await loadContacts(); // Recarrega para atualizar status
        } catch (error) {
            showNotification('❌ ' + error.message, true);
        }
    }

    async function makeMember(contactId) {
        try {
            const response = await fetch(`/api/contacts/${contactId}/make-member`, {
                method: 'POST',
                headers: getAuthHeaders()
            });

            const data = await response.json();
            
            if (!response.ok) throw new Error(data.message);

            showNotification('✅ Contato transformado em membro!');
            await loadContacts();
        } catch (error) {
            showNotification('❌ ' + error.message, true);
        }
    }

    async function markAsNotSent(contactId) {
        try {
            const response = await fetch(`/api/contacts/${contactId}/message-status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ receivedMessage: false })
            });

            if (!response.ok) throw new Error('Erro ao atualizar status');

            showNotification('✅ Status atualizado com sucesso!');
            await loadContacts();
        } catch (error) {
            showNotification('❌ ' + error.message, true);
        }
    }

    async function sendServiceReminder(phone, name, contactId) {
        try {
            const response = await fetch('/api/send-reminder', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ 
                    phone, 
                    name, 
                    contactId,
                    messageType: 'reminder'
                })
            });

            const data = await response.json();
            
            if (!response.ok) throw new Error(data.message);

            showNotification('✅ Lembrete enviado com sucesso!');
            // Não atualiza o status da mensagem principal
        } catch (error) {
            showNotification('❌ ' + error.message, true);
        }
    }

    // Função para exibir os contatos
    function displayContacts(contacts) {
        const contactsList = document.getElementById('contacts-list');
        contactsList.innerHTML = '';

        if (!contacts || contacts.length === 0) {
            contactsList.innerHTML = '<p class="no-contacts">Nenhum contato encontrado</p>';
            return;
        }

        // Ordena os contatos por data de criação (mais recentes primeiro)
        contacts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        contacts.forEach(contact => {
            const contactElement = createContactElement(contact);
            contactsList.appendChild(contactElement);
        });
    }

    // Função de logout
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('username'); 
        localStorage.removeItem('role');
        window.location.href = 'login.html';
    }

    // Função para carregar contatos por mês
    async function handleMonthFilter() {
        try {
            const monthSelect = document.getElementById('month-select');
            const selectedMonth = monthSelect.value;
            const monthName = monthNames[parseInt(selectedMonth) - 1];
            const monthResult = document.getElementById('month-result');
            
            // Oculta a mensagem se for "Todos os meses"
            if (selectedMonth === "0") {
                monthResult.style.display = 'none';
                const response = await fetch('/api/contacts', {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Erro ao carregar contatos');
                const data = await response.json();
                if (data.success) {
                    displayContacts(data.contacts);
                }
                return;
            }

            // Mostra a mensagem apenas quando um mês específico é selecionado
            monthResult.style.display = 'block';
            document.getElementById('selected-month').textContent = monthName;
            
            const response = await fetch(`/api/contacts/month/${selectedMonth}`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Erro ao filtrar contatos');

            const data = await response.json();
            if (!data.success) throw new Error('Erro ao carregar dados dos contatos filtrados');

            displayContacts(data.contacts);
            showNotification(`✅ Mostrando contatos de ${monthName}`);

        } catch (error) {
            console.error('Erro ao filtrar contatos:', error);
            showNotification('❌ ' + error.message, true);
        }
    }

    // Função para alternar o menu de ações
    function toggleActionMenu(button) {
        const actionMenu = button.nextElementSibling;
        const allMenus = document.querySelectorAll('.action-menu');
        
        // Fecha outros menus abertos
        allMenus.forEach(menu => {
            if (menu !== actionMenu) {
                menu.classList.remove('show');
            }
        });
        
        actionMenu.classList.toggle('show');

        // Adiciona o event listener para fechar ao clicar fora
        document.addEventListener('click', function closeMenu(e) {
            if (!button.contains(e.target) && !actionMenu.contains(e.target)) {
                actionMenu.classList.remove('show');
                document.removeEventListener('click', closeMenu);
            }
        });
    }

    // Remova o event listener antigo que estava interferindo
    document.removeEventListener('click', (e) => {
        if (!e.target.closest('.button-container')) {
            document.querySelectorAll('.action-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    // Adicione esta função para fechar modais
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            // Limpa os campos do formulário
            const form = modal.querySelector('form');
            if (form) {
                form.reset();
            }
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;

            const username = localStorage.getItem('username');
            const role = localStorage.getItem('role');

            if (username) {
                document.getElementById('username-display').innerHTML = `
                    <i class="fas fa-user"></i> ${username}
                `;
            }

            if (role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(btn => 
                    btn.style.display = 'block'
                );
            }

            if (username === 'Anderson') {
                document.querySelector('.anderson-only').style.display = 'block';
            }

            // Inicializa com todos os contatos
            document.getElementById('month-select').value = "0"; // Seleciona "Todos os meses"
            await handleMonthFilter(); // Carrega todos os contatos

        } catch (error) {
            console.error('Error initializing dashboard:', error);
            showNotification('❌ Error loading dashboard', true);
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.button-container')) {
            document.querySelectorAll('.action-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });
    </script>
</body>
</html>